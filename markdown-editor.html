<link rel="import" href="../polymer/polymer.html">

<!-- Paper elements -->
<link rel="import" href="../paper-input/paper-input-behavior.html">
<link rel="import" href="../paper-input/paper-input-container.html">

<!-- Molecule elements -->
<link rel="import" href="../marked-element/marked-element.html">

<!-- Custom elements -->
<link rel="import" href="medium-editor-markdown-import.html">

<!--
`<markdown-editor>` is a Medium.com WYSIWYG editor clone (https://github.com/yabwe/medium-editor#button-options) w/ a Markdown extension (https://github.com/IonicaBizau/medium-editor-markdown)

@demo demo/index.html 
-->

<dom-module id="markdown-editor">

  <template>

    <style>
      :host {
        display: block;
      }
      #preview {
        background-color: #ededed;
      }
      #preview[hidden] {
        display: none;
      }
    </style>

    <paper-input-container id="editor"
        always-float-label>
      <label>description</label>
      <marked-element id="marked" class="paper-input-input"
          on-marked-render-complete="_renderComplete">
        <div id="input" class="markdown-html" is="iron-input"></div>
      </marked-element>
    </paper-input-container>


    <pre id="preview" hidden="[[!preview]]">[[markdown]]</pre>

  </template>

  <script>
    Polymer({

      is: 'markdown-editor',

      properties: {
        markdown: {
          type: String,
          value: null
        },
        /**
         * Displaying preview of the markdown.
         */
        preview: {
          type: Boolean,
          reflectToAttribute: true,
          value: false
        },
        _initRender: {
          type: Boolean,
          value: false
        }
      },

      ready: function() {
        new MediumEditor(this.$.input, {
          extensions: {
            markdown: new MeMarkdown(function(md) {
              if (this._initRender) {
                // console.log(md);
                this.set('markdown', md);
              }
            }.bind(this)),
            code: new MediumEditorPhrase({
              name: 'code',
              aria: 'codeblock',
              contentDefault: '< />',
              phraseTagName: 'code'
            })
          },
          toolbar: {
            buttons: [
              'bold',
              'italic',
              'anchor',
              'code',
              'h1',
              'h2',
              'h3',
              'quote',
              'unorderedlist',
              'orderedlist',
              'removeFormat'
            ],
          },
          targetBlank: true,
          placeholder: false
        }).subscribe('editableKeypress', function(event, element) {
          // cleanse those span tags
          var spanList = element.getElementsByTagName('span');
          for (var i = 0; i < spanList.length; i++) {
            spanList[i].outerHTML = spanList[i].innerHTML;
          };
        });
      },

      attached: function() {
        if (this.markdown) {
          this.$.marked.markdown = this.markdown;
        } else {
          this.set('_initRender', true);
        }
      },

      _renderComplete: function(event) {
        this.set('_initRender', true);
      }

    });
  </script>

</dom-module>
