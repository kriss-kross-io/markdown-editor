<link rel="import" href="../polymer/polymer.html">

<!-- Paper elements -->
<link rel="import" href="../paper-input/paper-input-behavior.html">
<link rel="import" href="../paper-input/paper-input-container.html">

<!-- Molecule elements -->
<link rel="import" href="../marked-element/marked-element.html">

<!-- Custom elements -->
<link rel="import" href="medium-editor-markdown-import.html">

<link rel="import" href="../demo-content/shared-markdown-styles.html">

<!--
`<markdown-editor>` is a Medium.com WYSIWYG editor clone (https://github.com/yabwe/medium-editor#button-options) w/ a Markdown extension (https://github.com/IonicaBizau/medium-editor-markdown)

@demo demo/index.html 
-->

<dom-module id="markdown-editor">

  <template>

    <style include="shared-markdown-styles">
      :host {
        display: block;
      }
      #preview {
        background-color: #ededed;
        overflow-x: scroll;
      }
      #preview[hidden] {
        display: none;
      }
    </style>

    <paper-input-container id="editor"
        always-float-label>
      <label>description</label>
      <marked-element id="marked" class="paper-input-input">
        <div id="input" class="markdown-html" is="iron-input"></div>
      </marked-element>
    </paper-input-container>


    <pre id="preview" hidden="[[!preview]]">[[markdown]]</pre>

  </template>

  <script>
    Polymer({

      is: 'markdown-editor',

      properties: {
        /**
         * The markdown to be rendered
         */
        markdown: {
          type: String,
          notify: true
        },
        /**
         * Displaying a preview of the markdown when true
         */
        preview: {
          type: Boolean,
          reflectToAttribute: true,
          value: false
        }
      },

      ready: function() {
        this.renderMarkdown();

        new MediumEditor(this.$.input, {
          extensions: {
            markdown: new MeMarkdown(function(md) {
              // console.log('md:\n%O', md);
              this.set('markdown', md);
            }.bind(this))
          },
          toolbar: {
            buttons: [
              'bold',
              'italic',
              'anchor',
              'h1',
              'h2',
              'h3',
              'quote',
              'unorderedlist',
              'orderedlist',
              'removeFormat'
            ],
            static: true,
            sticky: true
          },
          paste: {
            forcePlainText: true
          },
          disableExtraSpaces: true,
          buttonLabels: 'fontawesome',
          targetBlank: true,
          placeholder: false
        }).subscribe('editableKeypress', function(event, element) {
          // cleanse those span tags
          var spanList = element.getElementsByTagName('span');
          for (var i = 0; i < spanList.length; i++) {
            spanList[i].outerHTML = spanList[i].innerHTML;
          };
        });
      },

      /**
       * Resets the input and applies the markdown property to `marked-element`
       */
      renderMarkdown: function() {
        this.$.input.innerHTML = null;

        this.$.marked.markdown = this.markdown;
      }

    });
  </script>

</dom-module>
